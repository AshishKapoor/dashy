# Dashy AI Guide

- Architecture: Django 5 API in [api/app](../api/app) with apps `accounts` and `bi`; React 19 + Vite UI in [ui/app](../ui/app) using alias `@` → `ui/app` and TANStack Query/OpenAPI client.
- Environment: backend settings load `.env.dev` by default ([api/app/settings/base.py](../api/app/settings/base.py)); docker-compose mounts `api/.env.dev` and sets `DJANGO_SETTINGS_MODULE=app.settings.dev`; DB is Postgres 17 service `db` ([docker-compose.yml](../docker-compose.yml)).
- Running backend locally: from [api](../api) use `make install|run|migrate|test|lint|format|shell` (uv-based) ([api/Makefile](../api/Makefile)). Inside Docker, use `docker compose run migrate` for migrations and `docker compose up` for api/ui/db.
- Auth: SimpleJWT with custom claims `username|email|user_id` ([api/app/accounts/auth_serializers.py](../api/app/accounts/auth_serializers.py)); token endpoints at `/api/auth/token`, `/api/auth/token/refresh`, `/api/auth/token/verify` ([api/app/urls.py](../api/app/urls.py)). Default permissions require authentication; CORS open in dev ([api/app/settings/dev.py](../api/app/settings/dev.py)).
- Domain models: Organizations/Users/Roles/Memberships ([api/app/accounts/models.py](../api/app/accounts/models.py)) exposed via DRF `ModelViewSet`s at `/api/accounts/...` with auth guard ([api/app/accounts/views.py](../api/app/accounts/views.py)). BI models Workspaces/Dashboards/Indicators (+ categories, values, dashboard-indicator joins) in [api/app/bi/models.py](../api/app/bi/models.py); viewsets scope queryset to the requesting user’s organization ([api/app/bi/views.py](../api/app/bi/views.py)).
- API docs: drf-spectacular schema at `/api/schema/`, Swagger UI at `/api/docs/` ([api/app/urls.py](../api/app/urls.py)).
- Ingestion scaffold: placeholder CSV/API/Google Sheets ingestion with status/log updates in [api/app/bi/services/ingestion.py](../api/app/bi/services/ingestion.py); extend mapping into IndicatorValue/DataModel there.
- Frontend boot: `pnpm install`, `pnpm dev` in [ui](../ui); Docker target `dev` exposes 5173. Build via `pnpm build`; lint via `pnpm lint` ([ui/package.json](../ui/package.json)).
- Routing/layout: app shell in [ui/app/app.tsx](../ui/app/app.tsx) uses React Router 7, `ProtectedRoute` to gate private routes, `AuthLayout` for login, `MainLayout` hosts nested feature routes.
- Auth client: tokens stored in `localStorage` keys `access_token`/`refresh_token`; helper `AuthProvider` handles login via generated `authTokenCreate`, refresh via `authTokenRefreshCreate`, redirects on logout ([ui/app/contexts/auth-context.tsx](../ui/app/contexts/auth-context.tsx); [ui/app/lib/auth.ts](../ui/app/lib/auth.ts)). Axios mutator injects bearer tokens and toasts on errors; redirects to `/login` on 401 ([ui/app/client/http-dashy-client.ts](../ui/app/client/http-dashy-client.ts)).
- OpenAPI client: generated with Orval from [ui/schema/dashy.yaml](../ui/schema/dashy.yaml) → hooks in [ui/app/client/gen/dashy](../ui/app/client/gen/dashy); regenerate via `pnpm generate:client`. Use provided query key helpers (e.g., `getAccountsOrganizationsListQueryKey`) for cache invalidation as in [ui/app/pages/accounts/organizations.tsx](../ui/app/pages/accounts/organizations.tsx).
- UI patterns: forms use `react-hook-form` + `zodResolver`, shadcn UI components, TanStack Query mutations with toast feedback and cache invalidation; see organizations page for create/edit/delete dialogs. Skeleton loaders used for list fetch states ([ui/app/pages/dashboard/index.tsx](../ui/app/pages/dashboard/index.tsx)).
- Theming: `ThemeProvider` with `vite-ui-theme` storage key and `Toaster` notifications initialized in app root ([ui/app/app.tsx](../ui/app/app.tsx)).
- Styling: Tailwind v4 via `@tailwindcss/vite`; global styles in [ui/app/assets/styles/globals.css](../ui/app/assets/styles/globals.css). Avoid importing from `node_modules` in Docker due to volume mount; container binds `/app/node_modules`.
- API base URL: Axios mutator picks `http://localhost:8000/` when `VITE_DEV_MODE=true`, otherwise `VITE_DATA_SERVICE_BASE_URL`; set env vars in Vite `.env` files to switch targets.
- Security/permissions: backend permissions default to `IsAuthenticated`; BI viewsets filter by `request.user.organization`, so ensure requests carry a user tied to an organization when seeding data.
- Testing: backend via `make test` (uv); no frontend test harness configured. Ruff handles lint+format; pre-commit recommended (`pre-commit install`).

When updating this guide, keep concrete, repo-specific steps and link to source files; avoid generic advice.